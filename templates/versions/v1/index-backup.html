<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROBIN</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
    .form-switch .form-check-input {width: 6em; height: 3em; border-width: 0.33em;}
    body{
        background-color: #F0F0F0;
    }
    </style>
</head>
<body>
    
    <!-- <div id="device-load-status" class="spinner-border position-absolute top-50 start-50" role="status"></div> -->

    <div class="container-fluid text-center">
        <div class="row my-3">
            <div class="col-12 text-start">
                <h1 id="toggleFullscreen">My Devices</h1>
            </div>
        </div>
        
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 my-2 border-bottom"></div>
        
        <div class="row">
            <div id="living-list" class="row text-start">
                <h3>Living & Dining Room</h3>
                    <!-- DEVICE LIST -->
            </div>
        </div>
        
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 my-2 border-bottom"></div>
    
        <div class="row">
            <div id="hallway-list" class="row text-start">
                <h3>Hallway Lights</h3>
                <!-- DEVICE LIST -->
            </div>
        </div>

        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 my-2 border-bottom"></div>

        <div class="row">
            <div id="bedroom-list" class="row text-start">
                <h3>Main Bedroom</h3>
                <!-- DEVICE LIST -->
            </div>
        </div>

        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 my-2 border-bottom"></div>

        <div class="row">
            <div id="outlet-list" class="row text-start">
                <h3>All Outlets</h3>
                <!-- DEVICE LIST -->
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        
        // Enter fullscreen
        document.getElementById("toggleFullscreen").addEventListener("click", function() {
            // If not in fullscreen mode, enter fullscreen.
            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                const elem = document.documentElement;

                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) { /* For Chrome */
                    elem.webkitRequestFullscreen();
                }
            } else {
                // If in fullscreen mode, exit.
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) { /* For Chrome */
                    document.webkitExitFullscreen();
                }
            }
        });

        $(document).ready(function(){

            $("#device-list").on("click", ".btn-toggle", function(event) {
                event.preventDefault(); // Prevents the default action
                $(this).find('.btn').toggleClass('active');  
                if ($(this).find('.btn-primary').length>0) {
                    $(this).find('.btn').toggleClass('btn-primary');
                }
                $(this).find('.btn').toggleClass('btn-default');
            });
            
            // TOGGLE DEVICE
            $(document).on('click', '.form-check-input', function() {

                var id = $(this).attr('id');
                var isChecked = $(this).prop('checked');
                var deviceAddr = $(`#deviceAddr_${id}`).val();
                var deviceMac = $(`#deviceMac_${id}`).val();
                var deviceModel = $(`#deviceModel_${id}`).val();
                
                $.ajax({
                    url: '/toggle_light',
                    type: 'POST',
                    data: {
                        'id': id,
                        'status': isChecked,
                        'deviceAddr': deviceAddr,
                        'deviceMac': deviceMac,
                        'deviceModel': deviceModel
                    },
                    success: function(response) {
                        console.log(response);
                    },
                    error: function(xhr, status, error) {
                        console.error("Error occurred:", error);
                    }
                });
            
            });

            // PAGE LOAD
            $.ajax({
                url: "/get_device_info",
                type: "GET",
                success: function(response){
                    $("#device-load-status").addClass("visually-hidden");
                    for (var ip in response) {
                        if (response.hasOwnProperty(ip)) {
                            var device = response[ip];

                            // SET DISPLAY VARIABLES
                            var deviceModel = device.model;
                            var deviceName = device.name;
                            var state = device.state;
                            var deviceAddr = device.addr;
                            var deviceMac = device.mac;
                            var deviceKey = device.key;
                            var deviceGroup = device.group;
                            var devChecked = 'checked';
                            if(state!=true){
                                devChecked='';
                            }
                            var isDimmable = '';
                            var deviceIcon = '';
                            var colorTemp = '';
                            var validTemp = '';
                            var deviceHSV = '';
                            var appendTo = '';
                            var ledState = '';
                            var onSince = '';
                            var currentConsumption = '';
                            var deviceBrightness = '';

                            // HS103(US) -> Wi-Fi Outlet
                            if(deviceModel == 'HS103(US)'){
                                ledState = device.led_state;
                                onSince = device.on_since;
                                deviceIcon = 'bi-outlet';
                                if(onSince== null){
                                    onSince = 'device turned off';
                                }
                                subCategory=`<p class="card-text">${onSince}</p>`;
                                appendTo=`#outlet-list`;
                            }

                            // KL125(US) -> Wi-Fi Bulb
                            if(deviceModel == 'KL125(US)'){
                                deviceIcon = 'bi-lamp';
                                deviceBrightness = device.brightness;
                                isDimmable = device.is_dimmable;
                                colorTemp = device.color_temp;
                                validTemp = device.valid_temp;
                                deviceHSV = device.hsv;
                                currentConsumption = device.current_consumption;
                                subCategory=`<div class="progress w-100" role="progressbar" aria-label="Example with label" aria-valuenow="${deviceBrightness}" aria-valuemin="0" aria-valuemax="100">
                                                <div class="progress-bar" style="width:${deviceBrightness}%; background-color: #ffd452b8;"></div>
                                            </div>
                                            <p class="card-text">${currentConsumption} Watts</p>
                                            `;
                                appendTo=`#${deviceGroup}-list`;
                            }
                        
                            var listItem = `
                            <div class="col-3 my-3">
                                <div class="shadow card">
                                    <div class="card-body">
                                        <i class="bi ${deviceIcon} mx-1" style="font-size: 6rem;"></i>
                                        <div class="form-check form-switch float-end">
                                            <input class="form-check-input" type="checkbox" role="switch" id="${deviceKey}" ${devChecked}>
                                            <label class="form-check-label" for="${deviceKey}"></label>
                                            <input type="hidden" id="deviceAddr_${deviceKey}" value="${deviceAddr}">
                                            <input type="hidden" id="deviceMac_${deviceKey}" value="${deviceMac}">
                                            <input type="hidden" id="deviceModel_${deviceKey}" value="${deviceModel}">
                                        </div>
                                        <h3 class="card-title mt-3">${deviceName}</h3>`;
                                        listItem+=subCategory;
                        listItem+=` </div>
                                </div>
                            </div>`;
                            
                            $(appendTo).append(listItem);
                        }
                    }
                }
            });

        });
    </script>
</body>
</html>